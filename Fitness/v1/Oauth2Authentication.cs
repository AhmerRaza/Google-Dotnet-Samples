// Copyright 2017 DAIMTO :  www.daimto.com
//
// Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with
// the License. You may obtain a copy of the License at
//
// http://www.apache.org/licenses/LICENSE-2.0
//
// Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on
// an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the
// specific language governing permissions and limitations under the License.
//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by DAIMTO-Google-apis-Sample-generator 1.0.0
//     Template File Name:  Oauth.tt
//     Build date: 01/02/2017 22:32:52
//     C# generater version: 1.0.0
//     
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------

// About 
// 
// Unoffical sample for the Fitness v1 API for C#. 
// This sample is designed to be used with the Google .Net client library. (https://github.com/google/google-api-dotnet-client)
// 
// API Description: Stores and accesses user data in the fitness store from apps on any platform.
// API Documentation Link https://developers.google.com/fit/rest/
//
// Discovery Doc  https://www.googleapis.com/discovery/v1/apis/Fitness/v1/rest
//
//------------------------------------------------------------------------------
// Installation
//
// This sample code uses the Google .Net client library 
//
// NuGet package:
//
// Location: https://www.nuget.org/packages/Google.Apis.Fitness.v1/ 
// Install Command: PM>  Install-Package Google.Apis.Fitness.v1
//
//------------------------------------------------------------------------------  
using Google.Apis.Auth.OAuth2;
using Google.Apis.Services;
using Google.Apis.Util.Store;
using System;
using System.IO;
using System.Threading;

namespace GoogleSamplecSharpSample.Fitnessv1.Auth
{  
    public static class Oauth2Example 
    {

        /// <summary>
        /// This method requests Authentcation from a user using Oauth2.  
        /// Credentials are stored in System.Environment.SpecialFolder.Personal
        /// Documentation https://developers.google.com/accounts/docs/OAuth2
        /// </summary>
        /// <param name="clientSecretJson">Path to the client secret json file from Google Developers console.</param>
        /// <param name="userName">Identifying string for the user who is being authentcated.</param>
        /// <returns>DriveService used to make requests against the Drive API</returns>
        public static FitnessService AuthenticateOauth(string clientSecretJson, string userName)
        {
            try
            {
                if (string.IsNullOrEmpty(userName))
                    throw new ArgumentNullException("userName");
                if (string.IsNullOrEmpty(clientSecretJson))
                    throw new ArgumentNullException("clientSecretJson");
                if (!File.Exists(clientSecretJson))
                    throw new Exception("clientSecretJson file does not exist.");
                
                // These are the scopes of permissions you need. It is best to request only what you need and not all of them
                string[] scopes = new string[] { FitnessService.Scope.FitnessReproductive_HealthWrite,	//View and store reproductive health data in Google Fit
                                                 FitnessService.Scope.FitnessReproductive_HealthRead, 	//View reproductive health data in Google Fit
                                                 FitnessService.Scope.FitnessOxygen_SaturationWrite,  	//View and store oxygen saturation data in Google Fit
                                                 FitnessService.Scope.FitnessBody_TemperatureWrite,   	//View and store body temperature data in Google Fit
                                                 FitnessService.Scope.FitnessOxygen_SaturationRead,   	//View oxygen saturation data in Google Fit
                                                 FitnessService.Scope.FitnessBody_TemperatureRead,    	//View body temperature data in Google Fit
                                                 FitnessService.Scope.FitnessBlood_PressureWrite,     	//View and store blood pressure data in Google Fit
                                                 FitnessService.Scope.FitnessBlood_GlucoseWrite,      	//View and store blood glucose data in Google Fit
                                                 FitnessService.Scope.FitnessBlood_PressureRead,      	//View blood pressure data in Google Fit
                                                 FitnessService.Scope.FitnessBlood_GlucoseRead,       	//View blood glucose data in Google Fit
                                                 FitnessService.Scope.FitnessNutritionWrite,          	//View and store nutrition information in Google Fit
                                                 FitnessService.Scope.FitnessActivityWrite,           	//View and store your activity information in Google Fit
                                                 FitnessService.Scope.FitnessLocationWrite,           	//View and store your location data in Google Fit
                                                 FitnessService.Scope.FitnessNutritionRead,           	//View nutrition information in Google Fit
                                                 FitnessService.Scope.FitnessActivityRead,            	//View your activity information in Google Fit
                                                 FitnessService.Scope.FitnessLocationRead,            	//View your stored location data in Google Fit
                                                 FitnessService.Scope.FitnessBodyWrite,               	//View and store body sensor data in Google Fit
                                                 FitnessService.Scope.FitnessBodyRead};              	//View body sensor information in Google Fit
                UserCredential credential;
                using (var stream = new FileStream(clientSecretJson, FileMode.Open, FileAccess.Read))
                {
                    string credPath = System.Environment.GetFolderPath(System.Environment.SpecialFolder.Personal);
                    credPath = Path.Combine(credPath, ".credentials/", System.Reflection.Assembly.GetExecutingAssembly().GetName().Name);

                    // Requesting Authentication or loading previously stored authentication for userName
                    credential = GoogleWebAuthorizationBroker.AuthorizeAsync(GoogleClientSecrets.Load(stream).Secrets,
                                                                             scopes,
                                                                             userName,
                                                                             CancellationToken.None,
                                                                             new FileDataStore(credPath, true)).Result;
                }

                // Create Drive API service.
                return new FitnessService(new BaseClientService.Initializer()
                {
                    HttpClientInitializer = credential,
                    ApplicationName = "Fitness Oauth2 Authentication Sample"
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine("Create Oauth2 account FitnessService failed" + ex.Message);
                throw new Exception("CreateServiceAccountFitnessFailed", ex);
			}
        }

        /// <summary>
        /// Authenticate to Google Using Oauth2
        /// Documentation https://developers.google.com/accounts/docs/OAuth2
        /// Credentials are stored in System.Environment.SpecialFolder.Personal
        /// </summary>
        /// <param name="clientId">From Google Developer console https://console.developers.google.com</param>
        /// <param name="clientSecret">From Google Developer console https://console.developers.google.com</param>
        /// <param name="userName">Identifying string for the user who is being authentcated.</param>
        /// <returns>SheetsService used to make requests against the Sheets API</returns>
        public static FitnessService AuthenticateOauth(string clientId, string clientSecret, string userName)
        {
            try
            {

                if (string.IsNullOrEmpty(clientId))
                    throw new ArgumentNullException("clientId");
                if (string.IsNullOrEmpty(clientSecret))
                    throw new ArgumentNullException("clientSecret");
                if (string.IsNullOrEmpty(userName))
                    throw new ArgumentNullException("userName");

                // These are the scopes of permissions you need. It is best to request only what you need and not all of them                
                string[] scopes = new string[] { FitnessService.Scope.FitnessReproductive_HealthWrite,	//View and store reproductive health data in Google Fit
                                                 FitnessService.Scope.FitnessReproductive_HealthRead, 	//View reproductive health data in Google Fit
                                                 FitnessService.Scope.FitnessOxygen_SaturationWrite,  	//View and store oxygen saturation data in Google Fit
                                                 FitnessService.Scope.FitnessBody_TemperatureWrite,   	//View and store body temperature data in Google Fit
                                                 FitnessService.Scope.FitnessOxygen_SaturationRead,   	//View oxygen saturation data in Google Fit
                                                 FitnessService.Scope.FitnessBody_TemperatureRead,    	//View body temperature data in Google Fit
                                                 FitnessService.Scope.FitnessBlood_PressureWrite,     	//View and store blood pressure data in Google Fit
                                                 FitnessService.Scope.FitnessBlood_GlucoseWrite,      	//View and store blood glucose data in Google Fit
                                                 FitnessService.Scope.FitnessBlood_PressureRead,      	//View blood pressure data in Google Fit
                                                 FitnessService.Scope.FitnessBlood_GlucoseRead,       	//View blood glucose data in Google Fit
                                                 FitnessService.Scope.FitnessNutritionWrite,          	//View and store nutrition information in Google Fit
                                                 FitnessService.Scope.FitnessActivityWrite,           	//View and store your activity information in Google Fit
                                                 FitnessService.Scope.FitnessLocationWrite,           	//View and store your location data in Google Fit
                                                 FitnessService.Scope.FitnessNutritionRead,           	//View nutrition information in Google Fit
                                                 FitnessService.Scope.FitnessActivityRead,            	//View your activity information in Google Fit
                                                 FitnessService.Scope.FitnessLocationRead,            	//View your stored location data in Google Fit
                                                 FitnessService.Scope.FitnessBodyWrite,               	//View and store body sensor data in Google Fit
                                                 FitnessService.Scope.FitnessBodyRead};              	//View body sensor information in Google Fit
								
				var credPath = System.Environment.GetFolderPath(System.Environment.SpecialFolder.Personal);
                credPath = System.IO.Path.Combine(credPath, ".credentials/apiName");

                // Requesting Authentication or loading previously stored authentication for userName
                var credential = GoogleWebAuthorizationBroker.AuthorizeAsync(new ClientSecrets { ClientId = clientId, ClientSecret = clientSecret }
                                                                                             , scopes
                                                                                             , userName
                                                                                             , CancellationToken.None
                                                                                             , new FileDataStore(credPath, true)).Result;
                // Returning the SheetsService
                return new FitnessService(new BaseClientService.Initializer()
                {
                    HttpClientInitializer = credential,
                    ApplicationName = "Fitness Oauth2 Authentication Sample"
                });
            }
            catch (Exception ex)
            {
                Console.WriteLine("Create Oauth2 account FitnessService failed" + ex.Message);
                throw new Exception("CreateServiceAccountFitnessFailed", ex);
			}
        }
    }
}